name: pitot Release

on:
  push:
    tags:
      - 'v*'
  release:
    types: [published]

env:
  BUILD_TYPE: Release

jobs:
  # Create release builds for all platforms
  release-build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            name: linux
            generator: "DEB;RPM;TGZ"
          - os: windows-latest
            name: windows
            generator: "NSIS;ZIP"
          - os: macos-latest
            name: macos
            generator: "DragNDrop;TGZ"

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4
      with:

        submodules: recursive
        token: ${{ secrets.SUBMODULE_TOKEN }}
    
    - name: Set up build environment (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake ninja-build rpm

    - name: Set up build environment (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install cmake ninja

    - name: Set up build environment (Windows)
      if: runner.os == 'Windows'
      uses: microsoft/setup-msbuild@v1.3

    - name: Extract version from tag
      id: version
      shell: bash
      run: |
        if [[ $GITHUB_REF == refs/tags/v* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION="0.0.0"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "major=$(echo $VERSION | cut -d. -f1)" >> $GITHUB_OUTPUT
        echo "minor=$(echo $VERSION | cut -d. -f2)" >> $GITHUB_OUTPUT
        echo "patch=$(echo $VERSION | cut -d. -f3)" >> $GITHUB_OUTPUT

    - name: Configure CMake
      run: |
        cmake -B ${{github.workspace}}/build \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DPITOT_VERSION_MAJOR=${{ steps.version.outputs.major }} \
          -DPITOT_VERSION_MINOR=${{ steps.version.outputs.minor }} \
          -DPITOT_VERSION_PATCH=${{ steps.version.outputs.patch }} \
          -DBUILD_TESTING=ON \
          -G Ninja

    - name: Build
      run: cmake --build ${{github.workspace}}/build --config ${{ env.BUILD_TYPE }} --parallel

    - name: Test
      working-directory: ${{github.workspace}}/build
      run: ctest --build-config ${{ env.BUILD_TYPE }} --output-on-failure --parallel

    - name: Create packages
      working-directory: ${{github.workspace}}/build
      run: cpack -G "${{ matrix.generator }}"

    - name: Validate packages
      working-directory: ${{github.workspace}}/build
      run: cmake --build . --target validate-packages

    - name: Upload release artifacts
      uses: actions/upload-artifact@v3
      with:
        name: pitot-${{ matrix.name }}-${{ steps.version.outputs.version }}
        path: |
          ${{github.workspace}}/build/*.deb
          ${{github.workspace}}/build/*.rpm
          ${{github.workspace}}/build/*.tar.gz
          ${{github.workspace}}/build/*.zip
          ${{github.workspace}}/build/*.dmg
          ${{github.workspace}}/build/*.exe

  # Create GitHub release
  create-release:
    needs: release-build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')

    steps:
    - uses: actions/checkout@v4
      with:

        submodules: recursive
        token: ${{ secrets.SUBMODULE_TOKEN }}
    
    - name: Extract version from tag
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Download all artifacts
      uses: actions/download-artifact@v3
      with:
        path: artifacts

    - name: Create release
      uses: softprops/action-gh-release@v1
      with:
        name: pitot v${{ steps.version.outputs.version }}
        body: |
          ## pitot v${{ steps.version.outputs.version }}
          
          ### Changes
          See [CHANGELOG.md](CHANGELOG.md) for detailed changes.
          
          ### Downloads
          - **Linux**: `.deb`, `.rpm`, and `.tar.gz` packages
          - **Windows**: `.exe` installer and `.zip` archive
          - **macOS**: `.dmg` disk image and `.tar.gz` archive
          
          ### Installation
          
          #### Linux (Ubuntu/Debian)
          ```bash
          sudo dpkg -i pitot-*-Linux-x86_64.deb
          ```
          
          #### Linux (RHEL/CentOS/Fedora)
          ```bash
          sudo rpm -i pitot-*-Linux-x86_64.rpm
          ```
          
          #### Windows
          Run the `.exe` installer or extract the `.zip` archive.
          
          #### macOS
          Open the `.dmg` file and drag pitot to Applications, or extract the `.tar.gz` archive.
          
          ### Verification
          All packages are built and tested on GitHub Actions. Package checksums:
          
        files: artifacts/**/*
        draft: false
        prerelease: ${{ contains(steps.version.outputs.version, '-') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Publish to package repositories (if configured)
  publish-packages:
    needs: create-release
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-')

    steps:
    - name: Download Linux artifacts
      uses: actions/download-artifact@v3
      with:
        name: pitot-linux-*
        path: packages

    - name: Publish to APT repository
      if: env.APT_REPO_URL != ''
      run: |
        # This would publish to an APT repository
        # Implementation depends on your specific repository setup
        echo "Publishing DEB packages to APT repository"
        # curl -T packages/*.deb $APT_REPO_URL
      env:
        APT_REPO_URL: ${{ secrets.APT_REPO_URL }}

    - name: Publish to YUM repository
      if: env.YUM_REPO_URL != ''
      run: |
        # This would publish to a YUM repository
        # Implementation depends on your specific repository setup
        echo "Publishing RPM packages to YUM repository"
        # curl -T packages/*.rpm $YUM_REPO_URL
      env:
        YUM_REPO_URL: ${{ secrets.YUM_REPO_URL }}