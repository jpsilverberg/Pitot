name: DataPools Quality Gates

on:
  pull_request:
    branches: [ main, develop ]
  # Only run on pushes to main branch to reduce costs
  push:
    branches: [ main ]

jobs:
  # Code formatting check
  format-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
    
        submodules: recursive
        token: ${{ secrets.SUBMODULE_TOKEN }}
    
    - name: Install clang-format
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format-14
    
    - name: Check code formatting
      run: |
        find include Tests -name "*.cpp" -o -name "*.cxx" -o -name "*.h" -o -name "*.hpp" | \
        xargs clang-format-14 --dry-run --Werror --style=file
    
    - name: Generate formatting diff
      if: failure()
      run: |
        echo "Code formatting issues found. Run the following to fix:"
        echo "find include Tests -name '*.cpp' -o -name '*.cxx' -o -name '*.h' -o -name '*.hpp' | xargs clang-format-14 -i --style=file"

  # Static analysis quality gate
  static-analysis:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:

        submodules: recursive
        token: ${{ secrets.SUBMODULE_TOKEN }}
    
    - name: Install analysis tools
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-tidy-14 cppcheck build-essential cmake

    - name: Configure CMake with static analysis
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_C_COMPILER=clang-14 \
          -DCMAKE_CXX_COMPILER=clang++-14 \
          -DENABLE_CLANG_TIDY=ON \
          -DENABLE_CPPCHECK=ON \
          -DBUILD_TESTING=OFF \
          -G "Unix Makefiles"

    - name: Run clang-tidy
      run: |
        # Build first to generate compile_commands.json
        cmake --build build --parallel
        
        # Run clang-tidy with explicit C++ standard and system includes
        find include -name "*.h" -o -name "*.hpp" | \
        xargs clang-tidy-14 \
          --checks="-*,bugprone-*,cert-*,clang-analyzer-*,cppcoreguidelines-*,google-*,hicpp-*,misc-*,modernize-*,performance-*,portability-*,readability-*,-readability-magic-numbers,-cppcoreguidelines-avoid-magic-numbers,-google-readability-todo,-hicpp-signed-bitwise,-modernize-use-trailing-return-type" \
          --extra-arg=-std=c++17 \
          --extra-arg=-I/usr/include/c++/9 \
          --extra-arg=-I/usr/include/x86_64-linux-gnu/c++/9 \
          --extra-arg=-I/usr/include/c++/9/backward \
          --header-filter='include/.*' \
          -p build \
          2>&1 | tee clang-tidy-output.txt
        
        # Check for actual errors (not warnings)
        if grep -q "error:" clang-tidy-output.txt && ! grep -q "warnings generated" clang-tidy-output.txt; then
          echo "::error::clang-tidy found compilation errors"
          cat clang-tidy-output.txt
          exit 1
        fi
        
        # Count and report warnings
        WARNING_COUNT=$(grep -c "warning:" clang-tidy-output.txt || echo "0")
        echo "::notice::clang-tidy found $WARNING_COUNT warnings"

    - name: Run cppcheck
      run: |
        cppcheck \
          --enable=all \
          --std=c++14 \
          --verbose \
          --quiet \
          --error-exitcode=1 \
          --inline-suppr \
          --suppress=missingIncludeSystem \
          --suppress=unmatchedSuppression \
          --suppress=unusedFunction \
          -I include \
          -I ../include \
          include Tests \
          2>&1 | tee cppcheck-output.txt
        
        if grep -q "error:" cppcheck-output.txt; then
          echo "::error::cppcheck found errors"
          exit 1
        fi

  # Build quality gate - reduced matrix
  build-quality:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Only test essential combinations
        include:
          - compiler: gcc-11
            build_type: Release
          - compiler: clang-14
            build_type: Debug
    
    steps:
    - uses: actions/checkout@v4
      with:

        submodules: recursive
        token: ${{ secrets.SUBMODULE_TOKEN }}
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake gcc-11 g++-11 clang-14 clang++-14

    - name: Set compiler environment
      run: |
        if [ "${{ matrix.compiler }}" = "gcc-11" ]; then
          echo "CC=gcc-11" >> $GITHUB_ENV
          echo "CXX=g++-11" >> $GITHUB_ENV
        else
          echo "CC=clang-14" >> $GITHUB_ENV
          echo "CXX=clang++-14" >> $GITHUB_ENV
        fi

    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DBUILD_TESTING=ON \
          -G "Unix Makefiles"

    - name: Build with warnings as errors
      run: cmake --build build --parallel

    - name: Run tests
      working-directory: build
      run: ctest --output-on-failure --parallel

  # Test coverage quality gate
  coverage-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:

        submodules: recursive
        token: ${{ secrets.SUBMODULE_TOKEN }}
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake gcc-11 g++-11 lcov bc
        
        # Try to install gcov-11, fallback to creating symlink if not available
        if ! sudo apt-get install -y gcov-11; then
          echo "gcov-11 package not available, creating symlink"
          sudo ln -sf /usr/bin/gcov-11 /usr/local/bin/gcov-11 || \
          sudo ln -sf $(which gcov) /usr/local/bin/gcov-11
        fi
        
        # Verify gcov-11 is available
        gcov-11 --version

    - name: Configure CMake with coverage
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_C_COMPILER=gcc-11 \
          -DCMAKE_CXX_COMPILER=g++-11 \
          -DENABLE_COVERAGE=ON \
          -DBUILD_TESTING=ON \
          -G "Unix Makefiles"
      env:
        GCOV: gcov-11

    - name: Build
      run: cmake --build build --parallel

    - name: Run tests with coverage
      working-directory: build
      run: |
        # Debug: Show gcov version
        echo "Using gcov version:"
        gcov-11 --version || echo "gcov-11 not found"
        
        # Run tests
        ctest --output-on-failure --parallel
        
        # Generate coverage with explicit gcov tool
        GCOV=gcov-11 make coverage
      env:
        GCOV: gcov-11

    - name: Check coverage threshold
      working-directory: build
      run: |
        # Extract coverage percentage from lcov output
        COVERAGE=$(lcov --summary coverage.info.cleaned 2>&1 | grep "lines" | grep -o '[0-9.]*%' | head -1 | sed 's/%//')
        echo "Current coverage: ${COVERAGE}%"
        
        # Set minimum coverage threshold
        MIN_COVERAGE=80
        
        if (( $(echo "$COVERAGE < $MIN_COVERAGE" | bc -l) )); then
          echo "::error::Coverage ${COVERAGE}% is below minimum threshold of ${MIN_COVERAGE}%"
          exit 1
        else
          echo "::notice::Coverage ${COVERAGE}% meets minimum threshold of ${MIN_COVERAGE}%"
        fi

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        directory: build/coverage
        fail_ci_if_error: false

  # Memory safety quality gate - only on PRs to main
  memory-safety:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    strategy:
      matrix:
        sanitizer: [address]  # Only most important sanitizer
    
    steps:
    - uses: actions/checkout@v4
      with:

        submodules: recursive
        token: ${{ secrets.SUBMODULE_TOKEN }}
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake clang-14

    - name: Configure CMake with sanitizers
      run: |
        SANITIZER_FLAG=""
        case "${{ matrix.sanitizer }}" in
          address) SANITIZER_FLAG="-DENABLE_ASAN=ON" ;;
          thread) SANITIZER_FLAG="-DENABLE_TSAN=ON" ;;
          undefined) SANITIZER_FLAG="-DENABLE_UBSAN=ON" ;;
        esac
        
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_C_COMPILER=clang-14 \
          -DCMAKE_CXX_COMPILER=clang++-14 \
          $SANITIZER_FLAG \
          -DBUILD_TESTING=ON \
          -G "Unix Makefiles"

    - name: Build with sanitizers
      run: cmake --build build --parallel

    - name: Run tests with sanitizers
      working-directory: build
      run: ctest --output-on-failure --parallel

  # Documentation quality gate
  documentation-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:

        submodules: recursive
        token: ${{ secrets.SUBMODULE_TOKEN }}
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y doxygen graphviz

    - name: Check for documentation
      run: |
        # Check that all public headers have documentation
        find include -name "*.h" -o -name "*.hpp" | while read file; do
          if ! grep -q "///" "$file" && ! grep -q "/\*\*" "$file"; then
            echo "::warning::Missing documentation in $file"
          fi
        done

    - name: Generate documentation
      run: |
        if [ -f "doxygen.conf" ]; then
          doxygen doxygen.conf
        else
          echo "::warning::No doxygen configuration found"
        fi

  # Performance regression check - only for PRs to main
  performance-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
        token: ${{ secrets.SUBMODULE_TOKEN }}
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake

    - name: Build current version
      run: |
        cmake -B build-current \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_TESTING=ON \
          -G "Unix Makefiles"
        cmake --build build-current --parallel

    - name: Run current benchmarks
      working-directory: build-current
      run: |
        if ctest -N | grep -q "Performance"; then
          ctest -R "Performance" --output-on-failure > ../current-benchmarks.txt || true
        else
          echo "No performance tests found" > ../current-benchmarks.txt
        fi

    - name: Build baseline version
      run: |
        git checkout ${{ github.event.pull_request.base.sha }}
        cmake -B build-baseline \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_TESTING=ON \
          -G "Unix Makefiles"
        cmake --build build-baseline --parallel

    - name: Run baseline benchmarks
      working-directory: build-baseline
      run: |
        if ctest -N | grep -q "Performance"; then
          ctest -R "Performance" --output-on-failure > ../baseline-benchmarks.txt || true
        else
          echo "No performance tests found" > ../baseline-benchmarks.txt
        fi

    - name: Compare performance
      run: |
        echo "::notice::Performance comparison completed"
        echo "Baseline results:"
        cat baseline-benchmarks.txt || echo "No baseline results"
        echo "Current results:"
        cat current-benchmarks.txt || echo "No current results"